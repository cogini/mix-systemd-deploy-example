#!/usr/bin/env bash

# Build task

set -e

export LANG="${LANG:-en_US.UTF-8}"
export MIX_ENV="${MIX_ENV:-prod}"

CURDIR="$PWD"
BINDIR=$(dirname "$0")
cd "$BINDIR"; BINDIR="$PWD"; cd "$CURDIR"

BASEDIR="$BINDIR/.."
cd "$BASEDIR"

echo "==> Running build task"

echo "===> Updating Elixir libs"
mix deps.get --only "$MIX_ENV"

echo "===> Compiling"
mix compile

echo "===> Generating assets"
# (cd assets && npm install && node node_modules/brunch/bin/brunch build)
(cd assets && npm install && node node_modules/webpack/bin/webpack.js --mode development)

echo "Building digest"
mix phx.digest

echo "===> Building release"
mix release
