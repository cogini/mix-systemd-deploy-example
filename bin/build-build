#!/usr/bin/env bash

# Build task

set -e

if [ ! -z "$BUILD_DIR" ]; then
    cd "$BUILD_DIR" || exit 1
fi

export LANG="${LANG:-en_US.UTF-8}"

APPLICATION_NAME="${APPLICATION_NAME:-cloud_native}"
ENVIRONMENT_NAME="${ENVIRONMENT_NAME:-prod}"
COMPONENT_NAME="${COMPONENT_NAME:-app}"
CONFIG_S3_BUCKET="${CONFIG_S3_BUCKET:-$APPLICATION_NAME-$ENVIRONMENT_NAME-$COMPONENT_NAME-config}"


echo "==> Running build task"

ENVIRONMENT_FILE="rel/etc/environment"
echo "===> Generating $ENVIRONMENT_FILE"
echo "APPLICATION_NAME=${APPLICATION_NAME}" > "$ENVIRONMENT_FILE"
echo "ENVIRONMENT_NAME=${ENVIRONMENT_NAME}" >> "$ENVIRONMENT_FILE"
echo "COMPONENT_NAME=${COMPONENT_NAME}" >> "$ENVIRONMENT_FILE"
echo "CONFIG_S3_BUCKET=${CONFIG_S3_BUCKET}" >> "$ENVIRONMENT_FILE"

echo "===> Building release"
make release
